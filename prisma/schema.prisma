// prisma/schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Program {
  id              String   @id @default(uuid())
  title           String
  description     String?
  languagePrimary String
  languagesAvailable String[]
  status          Status   @default(DRAFT)
  publishedAt     DateTime?
  topics    ProgramTopic[]  @relation("ProgramTopics")
  terms           Term[]
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([id])
  @@index([status, languagePrimary, publishedAt])
}

model Term {
  id          String   @id @default(uuid())
  programId   String
  termNumber  Int
  title       String?
  lessons     Lesson[]
  program     Program   @relation(fields: [programId], references: [id], onDelete: Cascade)
  createdAt   DateTime @default(now())

  @@unique([programId, termNumber])
  @@index([programId])
}

model Lesson {
  id                   String         @id @default(uuid())
  termId               String
  lessonNumber         Int
  title                String
  contentType          ContentType
  durationMs           Int?
  isPaid               Boolean        @default(false)
  contentLanguagePrimary String
  contentLanguagesAvailable String[]
  contentUrlsByLanguage Json?
  subtitleLanguages    String[]
  subtitleUrlsByLanguage Json?
  status               LessonStatus   @default(DRAFT)
  publishAt            DateTime?
  publishedAt          DateTime?
  assets               LessonAsset[]
  term                 Term           @relation(fields: [termId], references: [id], onDelete: Cascade)
  createdAt            DateTime       @default(now())
  updatedAt            DateTime       @updatedAt

  @@unique([termId, lessonNumber])
  @@index([status, publishAt])
  @@index([termId, lessonNumber])
}

model LessonAsset {
  id        String @id @default(uuid())
  lessonId  String
  language  String
  variant   AssetVariant
  assetType AssetType
  url       String
  lesson    Lesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@unique([lessonId, language, variant, assetType])
  @@index([lessonId])
}

model Topic {
  id       String         @id @default(uuid())
  name     String         @unique
  programs ProgramTopic[]
  
  @@index([name])
}

model ProgramTopic {
  programId String
  topicId   String
  program   Program @relation("ProgramTopics", fields: [programId], references: [id])
  topic     Topic   @relation(fields: [topicId], references: [id])
  
  @@id([programId, topicId])
}

enum Status {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum ContentType {
  VIDEO
  ARTICLE
}

enum LessonStatus {
  DRAFT
  SCHEDULED
  PUBLISHED
  ARCHIVED
}

enum AssetVariant {
  PORTRAIT
  LANDSCAPE
  SQUARE
  BANNER
}

enum AssetType {
  POSTER
  THUMBNAIL
  SUBTITLE
}

